[
    {
        "trigger_sql": "drop trigger if exists cpu_screen_off_overload_trigger;\r\ncreate trigger if not exists cpu_screen_off_overload_trigger after insert on agg_cpuagent_daily for each row when\r\n(select cast(getprop('main.audio_screen_off_play_duration') as int)) <= 600000\r\nand\r\n(select store('{alertId}', (select sum(case when json_extract(value, '$.screen_mode') = '0' then json_extract(value, '$.total_eg') else 0 end)/1000000 as total_eg from json_each(agg_cpuagent_daily.bg_cpu_energy) , agg_cpuagent_daily))) > 320\r\nBEGIN\r\nselect alert('{alertId}', {alertVersion}, 'cpu background energy exceed 516mAh', load('{alertId}'), 0), upload_db('{alertId}', -86400000, 0, 0), trigger_log(1, '{alertId}', 60, 23);\r\nEND;", 
        "install_if": "", 
        "name": "cpu_screen_off_background_overload", 
        "enable": 1
    }, 
    {
        "trigger_sql": "drop trigger if exists cpu_total_du_overload_trigger;\r\ncreate trigger if not exists cpu_total_du_overload_trigger after insert on trig_hour_timer_eventAgent for each row when\r\n(select alert_cnt('{alertId}')) = 0\r\nand\r\n(select store('{alertId}', (\r\nselect sum(total_duration) as total_duration_sum from agg_uidstate_cpuagent_hourly where start_ts >= NEW.otime - (2*60*60*1000) and end_ts <= NEW.otime - (60*60*1000) and type = 0\r\n))) > 32822000\r\nBEGIN\r\nselect alert('{alertId}', {alertVersion}, 'cpu total_du overload triggered', load('{alertId}'), 0), upload_db('{alertId}', -2*3600000, 0, 0), trigger_log(1, '{alertId}', 60, 23);\r\nEND;", 
        "install_if": "", 
        "name": "cpu_total_du_overload", 
        "enable": 1
    }, 
    {
        "trigger_sql": "drop trigger if exists cpu_big_du_overload_trigger;\r\ncreate trigger if not exists cpu_big_du_overload_trigger after insert on trig_hour_timer_eventAgent for each row when\r\n(select alert_cnt('{alertId}')) = 0\r\nand\r\n(\r\nselect store('{alertId}', (select (sum(c1_duration) / sum(total_duration)) as big_ratio from agg_uidstate_cpuagent_hourly where start_ts >= NEW.otime - (2*60*60*1000) and end_ts <= NEW.otime - (60*60*1000) and type = 0))\r\n) > 0.3\r\nBEGIN\r\nselect alert('{alertId}', {alertVersion}, 'cpu big_du overload triggered', load('{alertId}'), 0), upload_db('{alertId}', -2*3600000, 0, 0), trigger_log(1, '{alertId}', 60, 23);\r\nEND;", 
        "install_if": "", 
        "name": "cpu_big_du_overload", 
        "enable": 1
    }, 
    {
        "trigger_sql": "drop trigger if exists cpu_screen_on_bg_overload_trigger;\r\ncreate trigger if not exists cpu_screen_on_bg_overload_trigger after insert on agg_cpuagent_daily for each row when\r\n(select cast(getprop('main.audio_screen_off_play_duration') as int)) <= 600000\r\nand\r\n(select store('{alertId}', (select sum(case when json_extract(value, '$.screen_mode') = '1' then json_extract(value, '$.total_eg') else 0 end)/1000000 as total_eg from json_each(agg_cpuagent_daily.bg_cpu_energy) , agg_cpuagent_daily))) > 1960\r\nBEGIN\r\nselect alert('{alertId}', {alertVersion}, 'cpu screen on bg overload triggered', load('{alertId}'), 0), upload_db('{alertId}', -86400000, 0, 0), trigger_log(1, '{alertId}', 60, 23);\r\nEND;", 
        "install_if": "", 
        "name": "cpu_screen_on_background_overload", 
        "enable": 1
    }, 
    {
        "trigger_sql": "drop trigger if exists cellular_background_online_trigger;\r\ncreate trigger if not exists cellular_background_online_trigger after insert on trig_hour_timer_eventAgent  for each row when\r\n(select alert_cnt('{alertId}')) = 0\r\nand\r\n(select store('{alertId}_du', (select sum(busy_du) from comp_cellularUidState_backward where start_ts >= NEW.otime - (60*60*1000) and end_ts <= NEW.otime and ground_mode = 0))) > 59.5 * 60 * 1000\r\nand\r\n(select store('{alertId}_trx', (select sum(rx_trans_byte + tx_trans_byte) from comp_cellularUidState_backward where start_ts >= NEW.otime - (60*60*1000) and end_ts <= NEW.otime and ground_mode = 0))) < 10 * 1024 * 1024\r\nBEGIN\r\n  select alert('{alertId}', {alertVersion}, 'cellular background online triggered', load('{alertId}_du') || ',' || load('{alertId}_trx'), 0), upload_db('{alertId}', -3*3600000, 0, 0), trigger_log(1, '{alertId}', 60, 23);\r\nEND;", 
        "install_if": "", 
        "name": "cellular_background_online", 
        "enable": 0
    }, 
    {
        "trigger_sql": "drop trigger if exists dsp_unsleep_alarm_trigger;\r\ncreate trigger if not exists dsp_unsleep_alarm_trigger after insert on trig_hour_timer_eventAgent for each row when\r\n(select alert_cnt('{alertId}')) = 0\r\nand\r\n(select store('{alertId}', (select sum(cdsp_sleep_duration)*100.0/sum(duration) from agg_dsp_app_hourly where start_ts >= NEW.otime - (60*60*1000) and end_ts <= NEW.otime))) < 50\r\nBEGIN\r\nselect alert('{alertId}', {alertVersion}, 'battery drain alert triggered', load('{alertId}'), 0), upload_db('{alertId}', -3*3600000, 0, 0), trigger_log(1, '{alertId}', 60, 23);\r\nEND;", 
        "install_if": "select case when vendor_name() like '%qcom%' then 1 else 0 end;", 
        "name": "dsp_unsleep_alarm", 
        "enable": 0
    }, 
    {
        "trigger_sql": "drop trigger if exists audio_volume_mute_trigger;\r\ncreate trigger if not exists audio_volume_mute_trigger after insert on comp_audioPower_audioAgent_intv for each row when\r\n(select sum(whole_eg) from comp_audioPower_audioAgent_intv where start_ts = NEW.start_ts and volume = 0) > (60000)\r\nBEGIN\r\nselect incprop('main.audio_volume_mute_alarm', 1);\r\nEND", 
        "install_if": "", 
        "name": "audio_volume_mute_alarm", 
        "enable": 0
    }, 
    {
        "trigger_sql": "drop trigger if exists battery_drain_alert_trigger;\r\ncreate trigger if not exists battery_drain_alert_trigger after insert on trig_level_Battery_eventAgent for each row when\r\n(select alert_cnt('{alertId}')) = 0\r\nand\r\n(select store('{alertId}', (select sum(state) from trig_level_Battery_eventAgent where state < 0 and otime > (NEW.otime - 24*3600000)))) <= -355\r\nBEGIN\r\nselect alert('{alertId}', {alertVersion}, 'battery drain alert triggered', load('{alertId}'), 0), upload_db('{alertId}', -86400000, 0, 0), trigger_log(1, '{alertId}', 60, 23);\r\nEND;", 
        "install_if": "", 
        "name": "battery_drain_alert", 
        "enable": 1
    }, 
    {
        "trigger_sql": "drop trigger if exists battery_screen_off_current_trigger;\r\ncreate trigger if not exists battery_screen_off_current_trigger after insert on agg_batteryAgent_daily for each row when\r\n(select alert_cnt('{alertId}')) = 0\r\nand\r\n(select store('{alertId}', (select -sum(json_extract(value, '$.rm_eg'))*3.6/sum(json_extract(value, '$.total_du'))  from agg_batteryAgent_daily, json_each(agg_batteryAgent_daily.energy) WHERE json_extract(value, '$.screen_mode') = 0 AND json_extract(value, '$.power_mode') = 0 and json_extract(value, '$.total_du') > 10*60*1000))) >= 230\r\nBEGIN\r\nselect alert('{alertId}', {alertVersion}, 'battery screen off current triggered', load('{alertId}'), 0), upload_db('{alertId}', -12*3600*1000, 0, 0), trigger_log(1, '{alertId}', 60, 23);\r\nEND", 
        "install_if": "", 
        "name": "battery_screen_off_current_alert", 
        "enable": 1
    }, 
    {
        "trigger_sql": "drop trigger if exists alarm_exceed_trigger;\ncreate trigger if not exists alarm_exceed_trigger after insert on trig_hour_timer_eventAgent for each row when\n(select alert_cnt('{alertId}')) = 0\nand\n(select store('{alertId}', (select sum(times) from agg_wakeupAgent_hourly where start_ts >= NEW.otime - (60*60*1000) and end_ts <= NEW.otime))) > 30\nBEGIN\nselect alert('{alertId}', '{alertVersion}', 'alarm times exceed triggered', load('{alertId}'), 0), upload_db('{alertId}', -3*3600000, 0, 0), trigger_log(1, 'alarm_warning', 60, 23);\nEND;", 
        "install_if": "", 
        "name": "wakeup_warning", 
        "enable": 1
    }, 
    {
        "trigger_sql": "drop trigger if exists ddr_high_freq_du_overload_trigger;\r\ncreate trigger if not exists ddr_high_freq_du_overload_trigger after insert on agg_ddr_app_hourly for each row when\r\n(select sum(duration) from agg_ddr_app_hourly where start_ts = NEW.start_ts and freq > 2000) > (1800)\r\nBEGIN\r\nselect incprop('main.ddr_high_freq_du_overload_warning', 1);\r\nEND;", 
        "install_if": "", 
        "name": "ddr_high_freq_du_overload_warning", 
        "enable": 0
    }, 
    {
        "trigger_sql": "drop trigger if exists wakelock_time_out_trigger;\r\ncreate trigger if not exists wakelock_time_out_trigger after insert on agg_wakeLockAgent_daily for each row when\r\n(select alert_cnt('{alertId}')) = 0\r\nand\r\n(select store('{alertId}', (select sum(total_time) from (select json_extract(value, '$.total_time') as total_time from (select value from agg_wakeLockAgent_daily, json_each(agg_wakeLockAgent_daily.total_time)))))) > (74000 * 1000)\r\nBEGIN\r\nselect alert('{alertId}', {alertVersion}, 'wakelock time out warning triggered', load('{alertId}'), 0), upload_db('{alertId}', -3*3600000, 0, 0), trigger_log(1, 'wakelock_time_out', 60, 23);\r\nEND;", 
        "install_if": "", 
        "name": "wakelock_time_out_warning", 
        "enable": 0
    }, 
    {
        "version": 3, 
        "trigger_sql": "drop trigger if exists cpu_app_overload_trigger;\r\ncreate trigger if not exists cpu_app_overload_trigger after insert on meta_daily_dcs_data for each row when\r\n(select alert_cnt('{alertId}')) = 0\r\nand\r\n(select count(*) from meta_daily_dcs_data\r\n\twhere date = NEW.date\r\n\t\tand start_ts = NEW.start_ts\r\n\t\tand end_ts = NEW.end_ts\r\n\t\tand agent in ('audio', 'cpu', 'cellular', 'display', 'gpu', 'wifi')\r\n) = 6\r\nBEGIN\r\nwith daily_data_table as (\r\n\t\tselect agent, daily_data\r\n\t\t\tfrom meta_daily_dcs_data\r\n\t\twhere date = NEW.date\r\n\t\t\tand start_ts = NEW.start_ts\r\n\t\t\tand end_ts = NEW.end_ts\r\n\t\t\tand agent in ('audio', 'cpu', 'cellular', 'display', 'gpu', 'wifi')\r\n\t), audio_table as (\r\n\t\tselect value as app_json\r\n\t\t\tfrom daily_data_table, json_each(daily_data)\r\n\t\twhere agent in ('audio') and key = 'top_app_by_mode' and value <> 'NULL'\r\n\t), cpu_table as (\r\n\t\tselect value as app_json\r\n\t\t\tfrom daily_data_table, json_each(daily_data)\r\n\t\twhere agent in ('cpu') and key = 'top_app' and value <> 'NULL'\r\n\t), cellular_table as (\r\n\t\tselect value as app_json\r\n\t\t\tfrom daily_data_table, json_each(daily_data)\r\n\t\twhere agent in ('cellular') and key = 'top_app_by_mode' and value <> 'NULL'\r\n\t), display_table as (\r\n\t\tselect value as app_json\r\n\t\t\tfrom daily_data_table, json_each(daily_data)\r\n\t\twhere agent in ('display') and key = 'by_app' and value <> 'NULL'\r\n\t), gpu_table as (\r\n\t\tselect value as app_json\r\n\t\t\tfrom daily_data_table, json_each(daily_data)\r\n\t\twhere agent in ('gpu') and key = 'fg_top_app_by_eg' and value <> 'NULL'\r\n\t), wifi_table as (\r\n\t\tselect value as app_json\r\n\t\t\tfrom daily_data_table, json_each(daily_data)\r\n\t\twhere agent in ('wifi') and key = 'top_app_by_mode' and value <> 'NULL'\r\n\t),\r\n\tbin_threshold_table (alert_id, bin_id, app_name, lower_bin_value, upper_bin_value, threshold) as (\r\n\t\tselect * from meta_alert_threshold where alert_id = '{alertId}'\r\n\t),\r\n\tbin_table (app_name, bin_id, bin_value) as (\r\n\t\tselect name\r\n\t\t\t, \"audio_time_poff_soff_bg_speaker\"\r\n\t\t\t, sum(value) /1000 as audio_time\r\n\t\tfrom(\r\n\t\t\tselect json_extract(value, '$.player_app') as name, json_extract(value, '$.energy.duration') as durations\r\n\t\t\tfrom json_each(app_json), audio_table\r\n\t\t\t\twhere json_extract(value, '$.power_mode') = 0\r\n\t\t\t\t\tand json_extract(value, '$.screen_mode') = 0\r\n\t\t\t\t\tand json_extract(value, '$.ground_mode') = 0\r\n\t\t\t\t\tand json_extract(value, '$.energy.channel') = 0 -- 0 for speaker\r\n\t\t\t)t , json_each(durations)\r\n\t\tgroup by name\r\n\t\tUNION\r\n\t\tselect name\r\n\t\t\t, \"audio_time_poff_sall_bg_bluetooth\"\r\n\t\t\t, sum(value) / 1000 as audio_time\r\n\t\tfrom(\r\n\t\t\tselect json_extract(value, '$.player_app') as name, json_extract(value, '$.energy.duration') as durations\r\n\t\t\tfrom json_each(app_json), audio_table\r\n\t\t\twhere json_extract(value, '$.power_mode') = 0\r\n\t\t\t\tand json_extract(value, '$.ground_mode') = 0\r\n\t\t\t\tand json_extract(value, '$.energy.channel') = 2 -- for bluetooth\r\n\t\t\t)t , json_each(durations)\r\n\t\tgroup by name\r\n\t\tUNION\r\n\t\tselect name\r\n\t\t\t, \"audio_duration_poff_soff_bg_all\"\r\n\t\t\t, sum(value) / 1000.0 as audio_time\r\n\t\tfrom(\r\n\t\t\tselect json_extract(value, '$.player_app') as name, json_extract(value, '$.energy.duration') as durations\r\n\t\t\tfrom json_each(app_json), audio_table\r\n\t\t\twhere json_extract(value, '$.power_mode') = 0\r\n\t\t\t\tand json_extract(value, '$.screen_mode') = 0\r\n\t\t\t\tand json_extract(value, '$.ground_mode') = 0\r\n\t\t\t)t , json_each(durations)\r\n\t\tgroup by name\r\n\t\tUNION\r\n\t\tselect name\r\n\t\t\t, \"audio_duration_poff_son_bg_all\"\r\n\t\t\t, sum(value) / 1000.0 as audio_time\r\n\t\tfrom(\r\n\t\t\tselect json_extract(value, '$.player_app') as name, json_extract(value, '$.energy.duration') as durations\r\n\t\t\tfrom json_each(app_json), audio_table\r\n\t\t\twhere json_extract(value, '$.power_mode') = 0\r\n\t\t\t\tand json_extract(value, '$.screen_mode') = 1\r\n\t\t\t\tand json_extract(value, '$.ground_mode') = 0\r\n\t\t\t)t , json_each(durations)\r\n\t\tgroup by name\r\n\t\tUNION\r\n\t\tselect name\r\n\t\t\t, \"audio_duration_poff_son_bg_bluetooth\"\r\n\t\t\t, sum(value) / 1000.0 as audio_time\r\n\t\tfrom(\r\n\t\t\tselect json_extract(value, '$.player_app') as name, json_extract(value, '$.energy.duration') as durations\r\n\t\t\tfrom json_each(app_json), audio_table\r\n\t\t\twhere json_extract(value, '$.power_mode') = 0\r\n\t\t\t\tand json_extract(value, '$.screen_mode') = 1\r\n\t\t\t\tand json_extract(value, '$.ground_mode') = 0\r\n\t\t\t\tand json_extract(value, '$.energy.channel') = 2 -- for bluetooth\r\n\t\t\t)t , json_each(durations)\r\n\t\tgroup by name\r\n\t\tUNION\r\n\t\tselect name\r\n\t\t\t, \"audio_duration_poff_son_bg_headset\"\r\n\t\t\t, sum(value) / 1000.0 as audio_time\r\n\t\tfrom(\r\n\t\t\tselect json_extract(value, '$.player_app') as name, json_extract(value, '$.energy.duration') as durations\r\n\t\t\tfrom json_each(app_json), audio_table\r\n\t\t\twhere json_extract(value, '$.power_mode') = 0\r\n\t\t\t\tand json_extract(value, '$.screen_mode') = 1\r\n\t\t\t\tand json_extract(value, '$.ground_mode') = 0\r\n\t\t\t\tand json_extract(value, '$.energy.channel') = 1 -- for headset\r\n\t\t\t)t , json_each(durations)\r\n\t\tgroup by name\r\n\t\tUNION\r\n\t\tselect name\r\n\t\t\t, \"audio_duration_poff_son_bg_speaker\"\r\n\t\t\t, sum(value) / 1000.0 as audio_time\r\n\t\tfrom(\r\n\t\t\tselect json_extract(value, '$.player_app') as name, json_extract(value, '$.energy.duration') as durations\r\n\t\t\tfrom json_each(app_json), audio_table\r\n\t\t\twhere json_extract(value, '$.power_mode') = 0\r\n\t\t\t\tand json_extract(value, '$.screen_mode') = 1\r\n\t\t\t\tand json_extract(value, '$.ground_mode') = 0\r\n\t\t\t\tand json_extract(value, '$.energy.channel') = 0 -- for speaker\r\n\t\t\t)t , json_each(durations)\r\n\t\tgroup by name\r\n\t\tUNION\r\n\t\tselect name\r\n\t\t\t, \"audio_duration_poff_son_fg_all\"\r\n\t\t\t, sum(value) / 1000.0 as audio_time\r\n\t\tfrom(\r\n\t\t\tselect json_extract(value, '$.player_app') as name, json_extract(value, '$.energy.duration') as durations\r\n\t\t\tfrom json_each(app_json), audio_table\r\n\t\t\twhere json_extract(value, '$.power_mode') = 0\r\n\t\t\t\tand json_extract(value, '$.screen_mode') = 1\r\n\t\t\t\tand json_extract(value, '$.ground_mode') = 1\r\n\t\t\t)t , json_each(durations)\r\n\t\tgroup by name\r\n\t\tUNION\r\n\t\tselect name\r\n\t\t\t, \"audio_duration_poff_son_fg_bluetooth\"\r\n\t\t\t, sum(value) / 1000.0 as audio_time\r\n\t\tfrom(\r\n\t\t\tselect json_extract(value, '$.player_app') as name, json_extract(value, '$.energy.duration') as durations\r\n\t\t\tfrom json_each(app_json), audio_table\r\n\t\t\twhere json_extract(value, '$.power_mode') = 0\r\n\t\t\t\tand json_extract(value, '$.screen_mode') = 1\r\n\t\t\t\tand json_extract(value, '$.ground_mode') = 1\r\n\t\t\t\tand json_extract(value, '$.energy.channel') = 2 -- for bluetooth\r\n\t\t\t)t , json_each(durations)\r\n\t\tgroup by name\r\n\t\tUNION\r\n\t\tselect name\r\n\t\t\t, \"audio_energy_poff_son_bg_all\"\r\n\t\t\t, sum(value) / 1000000.0 as audio_eg\r\n\t\tfrom(\r\n\t\t\tselect json_extract(value, '$.player_app') as name, json_extract(value, '$.energy.total_eg') as total_egs\r\n\t\t\tfrom json_each(app_json), audio_table\r\n\t\t\twhere json_extract(value, '$.power_mode') = 0\r\n\t\t\t\tand json_extract(value, '$.screen_mode') = 1\r\n\t\t\t\tand json_extract(value, '$.ground_mode') = 0\r\n\t\t\t)t , json_each(total_egs)\r\n\t\tgroup by name\r\n\t\tUNION\r\n\t\tselect name\r\n\t\t\t, \"audio_energy_poff_son_bg_bluetooth\"\r\n\t\t\t, sum(value) / 1000000.0 as audio_eg\r\n\t\tfrom(\r\n\t\t\tselect json_extract(value, '$.player_app') as name, json_extract(value, '$.energy.total_eg') as total_egs\r\n\t\t\tfrom json_each(app_json), audio_table\r\n\t\t\twhere json_extract(value, '$.power_mode') = 0\r\n\t\t\t\tand json_extract(value, '$.screen_mode') = 1\r\n\t\t\t\tand json_extract(value, '$.ground_mode') = 0\r\n\t\t\t\tand json_extract(value, '$.energy.channel') = 2 -- for bluetooth\r\n\t\t\t)t , json_each(total_egs)\r\n\t\tgroup by name\r\n\t\tUNION\r\n\t\tselect name\r\n\t\t\t, \"audio_energy_poff_son_bg_speaker\"\r\n\t\t\t, sum(value) / 1000000.0 as audio_eg\r\n\t\tfrom(\r\n\t\t\tselect json_extract(value, '$.player_app') as name, json_extract(value, '$.energy.total_eg') as total_egs\r\n\t\t\tfrom json_each(app_json), audio_table\r\n\t\t\twhere json_extract(value, '$.power_mode') = 0\r\n\t\t\t\tand json_extract(value, '$.screen_mode') = 1\r\n\t\t\t\tand json_extract(value, '$.ground_mode') = 0\r\n\t\t\t\tand json_extract(value, '$.energy.channel') = 0 -- for speaker\r\n\t\t\t)t , json_each(total_egs)\r\n\t\tgroup by name\r\n\t\tUNION\r\n\t\tselect name\r\n\t\t\t, \"audio_energy_poff_son_fg_all\"\r\n\t\t\t, sum(value) / 1000000.0 as audio_eg\r\n\t\tfrom(\r\n\t\t\tselect json_extract(value, '$.player_app') as name, json_extract(value, '$.energy.total_eg') as total_egs\r\n\t\t\tfrom json_each(app_json), audio_table\r\n\t\t\twhere json_extract(value, '$.power_mode') = 0\r\n\t\t\t\tand json_extract(value, '$.screen_mode') = 1\r\n\t\t\t\tand json_extract(value, '$.ground_mode') = 1\r\n\t\t\t)t , json_each(total_egs)\r\n\t\tgroup by name\r\n\t\tUNION\r\n\t\tselect json_extract(value, '$.name') as name\r\n\t\t\t, \"cellular_duration_poff_son_bg\"\r\n\t\t\t, sum(json_extract(value, '$.rx_time') + json_extract(value, '$.rx_5g_time')\r\n\t\t\t\t+ json_extract(value, '$.tx_4g_time') + json_extract(value, '$.tx_5g_time')\r\n\t\t\t) / 1000.0 as duration\r\n\t\tfrom json_each(app_json), cellular_table\r\n\t\twhere json_extract(value, '$.power_mode') = 0\r\n\t\t\tand json_extract(value, '$.screen_mode') = 1\r\n\t\t\tand json_extract(value, '$.ground_mode') = 0\r\n\t\tgroup by name\r\n\t\tUNION\r\n\t\tselect json_extract(value, '$.name') as name\r\n\t\t\t, \"cellular_energy_poff_soff_bg\"\r\n\t\t\t, sum(json_extract(value, '$.total_eg')) / 1000000.0 as duration\r\n\t\tfrom json_each(app_json), cellular_table\r\n\t\twhere json_extract(value, '$.power_mode') = 0\r\n\t\t\tand json_extract(value, '$.screen_mode') = 0\r\n\t\t\tand json_extract(value, '$.ground_mode') = 0\r\n\t\tgroup by name\r\n\t\tUNION\r\n\t\tselect json_extract(value, '$.name') as name\r\n\t\t\t, \"cellular_energy_poff_son_bg\"\r\n\t\t\t, sum(json_extract(value, '$.total_eg')) / 1000000.0 as duration\r\n\t\tfrom json_each(app_json), cellular_table\r\n\t\twhere json_extract(value, '$.power_mode') = 0\r\n\t\t\tand json_extract(value, '$.screen_mode') = 1\r\n\t\t\tand json_extract(value, '$.ground_mode') = 0\r\n\t\tgroup by name\r\n\t\tUNION\r\n\t\tselect json_extract(value, '$.name') as name\r\n\t\t\t, \"cpu_energy_pon_sall_bg\"\r\n\t\t\t, sum(json_extract(value, '$.total_eg')) / 1000000.0 as total_eg\r\n\t\tfrom json_each(app_json), cpu_table\r\n\t\twhere json_extract(value, '$.type') = 'uid'\r\n\t\t\tand json_extract(value, '$.power_mode') = '1'\r\n\t\t\tand json_extract(value, '$.ground_mode') = '0'\r\n\t\tgroup by name\r\n\t\tUNION\r\n\t\tselect json_extract(value, '$.name') as name\r\n\t\t\t, \"cpu_energy_poff_sall_bg\"\r\n\t\t\t, sum(json_extract(value, '$.total_eg')) / 1000000.0 as total_eg\r\n\t\tfrom json_each(app_json), cpu_table\r\n\t\twhere json_extract(value, '$.type') = 'uid'\r\n\t\t\tand json_extract(value, '$.power_mode') = '0'\r\n\t\t\tand json_extract(value, '$.ground_mode') = '0'\r\n\t\tgroup by name\r\n\t\tUNION\r\n\t\tselect json_extract(value, '$.name') as name\r\n\t\t\t, \"cpu_energy_poff_son_fg\"\r\n\t\t\t, sum(json_extract(value, '$.total_eg')) / 1000000.0 as total_eg\r\n\t\tfrom json_each(app_json), cpu_table\r\n\t\twhere json_extract(value, '$.type') = 'uid'\r\n\t\t\tand json_extract(value, '$.power_mode') = '0'\r\n\t\t\tand json_extract(value, '$.screen_mode') = '1'\r\n\t\t\tand json_extract(value, '$.ground_mode') = '1'\r\n\t\tgroup by name\r\n\t\tUNION\r\n\t\tselect\r\n\t\t\tname\r\n\t\t\t, 'display_duration_poff_son'\r\n\t\t\t, sum(value) / 1000.0 as duration\r\n\t\tfrom (\r\n\t\t\tselect\r\n\t\t\t\tjson_extract(value, '$.app') as name, json_extract(value, '$.duration') as durations\r\n\t\t\tfrom (\r\n\t\t\t\tselect\r\n\t\t\t\t\tjson_extract(value, '$.apps') as apps\r\n\t\t\t\tfrom json_each(app_json), display_table\r\n\t\t\t)t, json_each(apps)\r\n\t\t\twhere json_extract(value, '$.power_mode') = 0\r\n\t\t\t\tand json_extract(value, '$.screen_mode') = 1\r\n\t\t)t2, json_each(durations)\r\n\t\tgroup by name\r\n\t\tUNION\r\n\t\tselect\r\n\t\t\tjson_extract(value, '$.app') as name\r\n\t\t\t, \"gpu_duration_poff_son\"\r\n\t\t\t, sum(json_extract(value, '$.total_du')) / 1000.0 as duration\r\n\t\tfrom json_each(app_json), gpu_table\r\n\t\twhere json_extract(value, '$.power_mode') = 0\r\n\t\t\tand json_extract(value, '$.screen_mode') = 1\r\n\t\tgroup by name\r\n\t\tUNION\r\n\t\tselect json_extract(value, '$.package_name') as name\r\n\t\t\t, \"wifi_duration_poff_soff_bg\"\r\n\t\t\t, sum(json_extract(value, '$.busy_du')) / 1000.0 as duration\r\n\t\tfrom json_each(app_json), wifi_table\r\n\t\twhere json_extract(value, '$.power_mode') = 0\r\n\t\t\tand json_extract(value, '$.screen_mode') = 0\r\n\t\t\tand json_extract(value, '$.ground_mode') = 0\r\n\t\tgroup by name\r\n\t\tUNION\r\n\t\tselect json_extract(value, '$.package_name') as name\r\n\t\t\t, \"wifi_duration_poff_son_bg\"\r\n\t\t\t, sum(json_extract(value, '$.busy_du')) / 1000.0 as duration\r\n\t\tfrom json_each(app_json), wifi_table\r\n\t\twhere json_extract(value, '$.power_mode') = 0\r\n\t\t\tand json_extract(value, '$.screen_mode') = 1\r\n\t\t\tand json_extract(value, '$.ground_mode') = 0\r\n\t\tgroup by name\r\n\t\tUNION\r\n\t\tselect json_extract(value, '$.package_name') as name\r\n\t\t\t, \"wifi_energy_poff_son_bg\"\r\n\t\t\t, sum(json_extract(value, '$.total_eg')) / 1000000.0 as total_eg\r\n\t\tfrom json_each(app_json), wifi_table\r\n\t\twhere json_extract(value, '$.power_mode') = 0\r\n\t\t\tand json_extract(value, '$.screen_mode') = 1\r\n\t\t\tand json_extract(value, '$.ground_mode') = 0\r\n\t\tgroup by name\r\n\t\tUNION\r\n\t\tselect json_extract(value, '$.package_name') as name\r\n\t\t\t, \"wifi_rx_byte_poff_son_bg\"\r\n\t\t\t, sum(json_extract(value, '$.rx_byte')) / 1024.0 / 1024.0  as byte\r\n\t\tfrom json_each(app_json), wifi_table\r\n\t\twhere json_extract(value, '$.power_mode') = 0\r\n\t\t\tand json_extract(value, '$.screen_mode') = 1\r\n\t\t\tand json_extract(value, '$.ground_mode') = 0\r\n\t\tgroup by name\r\n\t\tUNION\r\n\t\tselect json_extract(value, '$.package_name') as name\r\n\t\t\t, \"wifi_tx_byte_poff_son_bg\"\r\n\t\t\t, sum(json_extract(value, '$.tx_byte')) / 1024.0 / 1024.0  as byte\r\n\t\tfrom json_each(app_json), wifi_table\r\n\t\twhere json_extract(value, '$.power_mode') = 0\r\n\t\t\tand json_extract(value, '$.screen_mode') = 1\r\n\t\t\tand json_extract(value, '$.ground_mode') = 0\r\n\t\tgroup by name\r\n\t\tUNION\r\n\t\tselect json_extract(value, '$.package_name') as name\r\n\t\t\t, \"wifi_tx_byte_poff_son_fg\"\r\n\t\t\t, sum(json_extract(value, '$.tx_byte')) / 1024.0 / 1024.0  as byte\r\n\t\tfrom json_each(app_json), wifi_table\r\n\t\twhere json_extract(value, '$.power_mode') = 0\r\n\t\t\tand json_extract(value, '$.screen_mode') = 1\r\n\t\t\tand json_extract(value, '$.ground_mode') = 1\r\n\t\tgroup by name\r\n\t\tUNION\r\n\t\tselect json_extract(value, '$.package_name') as name\r\n\t\t\t, \"wifi_time_poff_sall_bg\"\r\n\t\t\t, sum(json_extract(value, '$.tx_time') + json_extract(value, '$.rx_time')) / 1000 as wifi_time\r\n\t\tfrom json_each(app_json), wifi_table\r\n\t\twhere json_extract(value, '$.power_mode') = 0\r\n\t\t\tand json_extract(value, '$.ground_mode') = 0\r\n\t\tgroup by name\r\n\t\tUNION\r\n\t\tselect app_name\r\n\t\t\t, bin_id\r\n\t\t\t, 0\r\n\t\tfrom bin_threshold_table\r\n\t\twhere bin_id = 'default'\r\n\t),\r\n\tthreshold_table (bin_id, app_name, lower_bin_value, upper_bin_value, threshold, bin_value) as (\r\n\t\tselect t1.bin_id, t1.app_name, t1.lower_bin_value, t1.upper_bin_value, t1.threshold, t2.bin_value\r\n\t\tfrom bin_threshold_table t1 inner join bin_table t2\r\n\t\ton t1.bin_id = t2.bin_id\r\n\t\t\tand t2.bin_value >= t1.lower_bin_value\r\n\t\t\tand t2.bin_value < t1.upper_bin_value\r\n\t\twhere (instr(t2.app_name, obfuscate(t1.app_name)) > 0 or t1.app_name = t2.app_name)\r\n\t),\r\n\tcpu_bg_table (app_name, total_eg) as (\r\n\t\tselect json_extract(value, '$.name') as name\r\n\t\t\t, sum(json_extract(value, '$.total_eg')) / 1000000.0 as total_eg\r\n\t\tfrom json_each(app_json), cpu_table\r\n\t\twhere json_extract(value, '$.type') = 'uid' and json_extract(value, '$.ground_mode') = '0'\r\n\t\tgroup by name\r\n\t),\r\n\tresult_table (result) as (\r\n\t\tselect json_group_array(sub_result) from (\r\n\t\t\tselect json_object (\r\n\t\t\t\t'app_name', threshold_table.app_name\r\n\t\t\t\t, 'hash_app_name', cpu_bg_table.app_name\r\n\t\t\t\t, 'total_eg', cpu_bg_table.total_eg\r\n\t\t\t\t, 'bin_id', threshold_table.bin_id\r\n\t\t\t\t, 'lower_bin_value', threshold_table.lower_bin_value\r\n\t\t\t\t, 'upper_bin_value', threshold_table.upper_bin_value\r\n\t\t\t\t, 'bin_value', threshold_table.bin_value\r\n\t\t\t\t, 'threshold', threshold_table.threshold\r\n\t\t\t) as sub_result\r\n\t\t\tfrom cpu_bg_table inner join threshold_table\r\n\t\t\t\ton (instr(cpu_bg_table.app_name, obfuscate(threshold_table.app_name)) > 0 or (threshold_table.app_name = 'all'))\r\n\t\t\t\t\tand cpu_bg_table.total_eg > threshold_table.threshold\r\n\t\t)\r\n\t)\r\n\r\nselect alert('{alertId}'\r\n\t\t, {alertVersion}\r\n\t\t, 'cpu app power overload triggered'\r\n\t\t, json_object (\r\n\t\t\t'reason', result\r\n\t\t\t, 'upload_result',  upload_db('{alertId}', -86400000, 0, 0)\r\n\t\t\t, 'sys_log',  trigger_log(1, '{alertId}', 60, 23)\r\n\t\t\t, 'otrace_log',  triggerOTraceLog(10000)\r\n\t\t)\r\n\t\t, 0\r\n\t) as trigger_result\r\nfrom result_table\r\nwhere exists (\r\n\tselect *\r\n\tfrom result_table\r\n\twhere result is not null and result <> '[]'\r\n);\r\nEND;", 
        "install_if": "", 
        "name": "cpu_app_overload_alert", 
        "enable": 1
    }, 
    {
        "trigger_sql": "drop trigger if exists thermal_uptrend_cnt_warning_trigger;\r\ncreate trigger if not exists thermal_uptrend_cnt_warning_trigger after insert on agg_thermalAgent_daily for each row when\r\n(select alert_cnt('{alertId}')) = 0\r\nand\r\n(select store('{alertId}',\r\n    (\r\n        select sum(value) as dur\r\n        from(\r\n            select json_extract(value, '$.temp') as dur, json_extract(value, '$.type') as thermal_type\r\n            from json_each(agg_thermalAgent_daily.histogram) , agg_thermalAgent_daily\r\n        ), json_each(dur)\r\n        where id > 8\r\n        and thermal_type = 'shell_front'\r\n    )\r\n)) > 72000000\r\nBEGIN\r\nselect alert('{alertId}', {alertVersion}, 'thermal shell temp is higher than 42 celsius for 6000000s', load('{alertId}'), 0), upload_db('{alertId}', -86400000, 0, 0), trigger_log(1, '{alertId}', 60, 23);\r\nEND;", 
        "install_if": "", 
        "name": "thermal_uptrend_cnt_warning", 
        "enable": 1
    }
]
